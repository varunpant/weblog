<!doctype html><html lang=en><head><title>Serving raster layers on Google Cloud Platform :: Varun Pant — WebLog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="In this blog post, I will write about using Google cloud storage as a Raster Tile Server for static imagery.
In the GIS domain, various techniques are used to add custom raster overlay on top of a base maps, or to even use custom imagery, as a base map itself.
This approach is also useful if you have a large quantity of satellite or aerial imagery, that you need to serve at scale onto a Google map or any other GIS tool."><meta name=keywords content="Cloud,maps,GIS,Google Cloud,Google Maps,Openlayer,Javascript,go,Hadoop,BigData,Spark"><meta name=robots content="noodp"><link rel=canonical href=https://varunpant.com/posts/serving-raster-layers-on-google-cloud-platform/><link rel=stylesheet href=https://varunpant.com/assets/style.css><link rel=stylesheet href=https://varunpant.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://varunpant.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://varunpant.com/img/favicon.png><meta name=twitter:card content="summary"><meta name=twitter:title content="Serving raster layers on Google Cloud Platform"><meta name=twitter:description content="In this blog post, I will write about using Google cloud storage as a Raster Tile Server for static imagery.
In the GIS domain, various techniques are used to add custom raster overlay on top of a base maps, or to even use custom imagery, as a base map itself.
This approach is also useful if you have a large quantity of satellite or aerial imagery, that you need to serve at scale onto a Google map or any other GIS tool."><meta property="og:title" content="Serving raster layers on Google Cloud Platform"><meta property="og:description" content="In this blog post, I will write about using Google cloud storage as a Raster Tile Server for static imagery.
In the GIS domain, various techniques are used to add custom raster overlay on top of a base maps, or to even use custom imagery, as a base map itself.
This approach is also useful if you have a large quantity of satellite or aerial imagery, that you need to serve at scale onto a Google map or any other GIS tool."><meta property="og:type" content="article"><meta property="og:url" content="https://varunpant.com/posts/serving-raster-layers-on-google-cloud-platform/"><meta property="article:published_time" content="2015-09-21T00:00:00+00:00"><meta property="article:modified_time" content="2015-09-21T00:00:00+00:00"><meta property="og:site_name" content="Varun Pant"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Varun Pant</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archives>Archives</a></li><li><a href=/feed.xml>Feed</a></li><li><a href=/showcase>Showcase</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archives>Archives</a></li><li><a href=/feed.xml>Feed</a></li><li><a href=/showcase>Showcase</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h2 class=post-title><a href=https://varunpant.com/posts/serving-raster-layers-on-google-cloud-platform/>Serving raster layers on Google Cloud Platform</a></h2><div class=post-meta><span class=post-date>2015-09-21</span>
<span class=post-author>— Varun Pant</span>
<span class=post-read-time>— 7 min read</span></div><div class=post-content><p>In this blog post, I will write about using <a href=https://cloud.google.com/storage/>Google cloud storage</a> as a Raster Tile Server for static imagery.</p><p>In the GIS domain, various techniques are used to add custom raster overlay on top of a base maps, or to even use custom imagery, as a base map itself.</p><p>This approach is also useful if you have a large quantity of satellite or aerial imagery, that you need to serve at scale onto a Google map or any other GIS tool.</p><p>There are various clients out there for web as well as android or IOS, which provide an ability to add overlays while pointing to an external service for the image source.</p><p><a href=https://cloud.google.com/storage/>Google Cloud Storage</a> serves as a perfect online, static imagery severing service.</p><p>The general idea is to save map tiles, which are usually 256 x 256 sized images in the cloud and then point the client to the base url .</p><h2 id=map-tiles>Map tiles</h2><p>Map tiles can have various naming standards and can vary based on map projection.</p><p>This article focuses on map tiles in a <strong>z/x/y.png</strong> naming standard, where <strong>Z</strong> is the current zoom level, and <strong>X</strong> is the <strong>X coordinate</strong> and <strong>Y</strong> is the <strong>Y coordinate</strong>, measured from the top left of the map for each zoom level.</p><p>Google Maps, ESRI, Bing, Open Street Map, and others use this top left “standard.” However, the OGC standard, called TMS, starts from the bottom left.</p><p>You can see the differences in the two examples below, which show a typical tiles file structure (<strong>Z/X/Y.png</strong>), where, in the 4th X column of zoom level 4, there are two images for the Y coordinates.</p><p><a href=http://varunpant.com/static/resources/image_2.png><img src=http://varunpant.com/static/resources/image_thumb.png alt=image title=image></a></p><p>Note that their names are different based on whether counting began at the <strong>top left</strong> or <strong>bottom left</strong>.</p><p>The file structure in which your software exported the tiles will determine the logic you need to use in your application when you want to load a specific tile.</p><p>However, the file structure doesn’t impact the actual upload process.</p><h2 id=generating-map-tiles>Generating Map Tiles</h2><p>There are various open source tools , which can directly generate map tiles from a vector or raster data source. There is a great example <a href=http://blog.cartodb.com/tiles-on-gcs/>here</a> from CartoDB, which shows how to generate raster tiles from geotiff or shape files (Any OGC data Source supported by GDAL tools)</p><p>In this article , I will present an alternative way to do so, by using a python library called <a href=http://tilestache.org/>Tilestache</a> .</p><p>Tilestache is a map tiles server which seamlessly integrates with Google maps tiling scheme. It also provides a <a href=https://github.com/TileStache/TileStache/blob/master/scripts/tilestache-seed.py>seeding script</a> which can generate tiles on the disk and has plugins to directly add those tiles in the google cloud.</p><p>I prefer <a href=http://tilestache.org/>Tilestache</a> for various reasons, but most importantly because it is based on <a href=http://mapnik.org/>Mapnik</a>, therefore, one can use open source tools like <a href=https://www.mapbox.com/tilemill/>Tilemill</a> by <a href=https://www.mapbox.com/>mapbox</a> to style the maps and later export the <a href=https://www.mapbox.com/tilemill/docs/manual/exporting/>mapnik xml</a> directly, which in-turn, can later be configured in <a href=http://tilestache.org/>Tilestache</a> for generating highly styled images.</p><p>Here is a quick example of styling states of America, the style used in TileMill is below</p><p>#ne110madmin1statespr { line-color:#fff; line-width:1; polygon-opacity:0.5; text-name: &ldquo;[name]"; text-face-name: &ldquo;Arial Bold&rdquo;; } #ne110madmin1statespr { polygon-fill: #FFFFCC; } #ne110madmin1statespr[name_len >= 4 ] { polygon-fill: #D9F0A3; } #ne110madmin1statespr[name_len >= 7] { polygon-fill: #ADDD8E; } #ne110madmin1statespr[name_len >= 10] { polygon-fill: #78C679; } #ne110madmin1statespr[name_len >= 13] { polygon-fill: #41AB5D; } #ne110madmin1statespr[name_len >= 15] { polygon-fill: #238443; } #ne110madmin1statespr[name_len >= 20] { polygon-fill: #005A32; } Here is how it looks.</p><p><a href=http://varunpant.com/static/resources/image_4.png><img src=http://varunpant.com/static/resources/image_thumb_1.png alt=image title=image></a></p><p>Now we can easily extract the mapnik xml from the tilemill.</p><p>Next step is to configure a tilestache config file which is essentially a json document which is used by rendering engine to draw tiles. Here is a sample configuration</p><p>{ &ldquo;cache&rdquo;: { &ldquo;name&rdquo;: &ldquo;Disk&rdquo;, &ldquo;path&rdquo;: &ldquo;tiles&rdquo;, &ldquo;dirs&rdquo;: &ldquo;portable&rdquo;, &ldquo;umask&rdquo;: &ldquo;0000&rdquo; }, &ldquo;layers&rdquo;: { &ldquo;NE&rdquo;: { &ldquo;provider&rdquo;: {&ldquo;name&rdquo;: &ldquo;mapnik&rdquo;, &ldquo;mapfile&rdquo;: &ldquo;C:\Users\Varun Pant\Desktop\NE\NE.xml&rdquo;}, &ldquo;projection&rdquo;: &ldquo;spherical mercator&rdquo; } } } Few things to note in the above configuration is the attribute **cache **and attribute <strong>layers</strong>. <a href=http://tilestache.org/doc/TileStache.Caches.html>Cache</a> instructs the library to save the files onto the disk, the <strong>dirs</strong> attribute instructs the file structure to be of portable type which essentially means to save is <strong>X/Y/Z.png</strong> format on the disk.</p><p>Now to start the webserver, one can simply type in tilestache-server.py -c ne.cfg</p><p>I have also added a quick javascript below, which shows ,how to add a custom overlay on google maps and point it to our raster service.</p><p>function CustomOverlay(tileSize) { this.tileSize = tileSize; } CustomOverlay.prototype.getTile = function(coord, zoom, ownerDocument) { var img = ownerDocument.createElement(&lsquo;img&rsquo;); img.src = &ldquo;http://localhost:8080/NE/&rdquo; + zoom + &ldquo;/&rdquo; + coord.x + &ldquo;/&rdquo; + coord.y + &ldquo;.png&rdquo;; img.style.width = this.tileSize.width + &lsquo;px&rsquo;; img.style.height = this.tileSize.height + &lsquo;px&rsquo;; return img; }; var map; function initialize() { map = new google.maps.Map( document.getElementById(&ldquo;map-canvas&rdquo;), { center: new google.maps.LatLng(42.660851192127, -96.5624457296875), zoom: 4 }); map.overlayMapTypes.insertAt(0, new CustomOverlay(new google.maps.Size(256, 256))); } google.maps.event.addDomListener(window, &lsquo;load&rsquo;, initialize); If all goes well, then this is how the end result will look like.</p><p><a href=http://varunpant.com/static/resources/image_6.png><img src=http://varunpant.com/static/resources/image_thumb_2.png alt=image title=image></a></p><p>Here is a <a href=https://gist.github.com/varunpant/aad7e87ea1c8af8a673a>gist</a> with complete html mark-up.</p><p>As stated above, tilestache also allows to just create static images on the disk instead of serving them, which is very usefull if one wants to serve these tiles fronted by a proxy or load it to cloud like Google or amazon data storage.</p><p>The Command to do so is tilestache-seed.py –<strong>c</strong> .cfg –<strong>l</strong> –<strong>b</strong> <strong>-e</strong> png</p><p>In my case,I will use the bounding box of my shapefile and the command goes like this tilestache-seed.py -c ne.cfg -l NE -b 18.9161900000001420 -171.7911106028911700 71.3577635769417500 -66.9646599999999810 -e png 1 2 3 4 5 6 7 8</p><p>This is how the folders are created in my <strong>cache directory</strong>, which is configured in the <strong>ne.cfg</strong> shown above.</p><p><a href=http://varunpant.com/static/resources/image_8.png><img src=http://varunpant.com/static/resources/image_thumb_3.png alt=image title=image></a></p><h2 id=uploading-data-to-the-cloud>Uploading data to the cloud</h2><p>So now that we have our tiles generated, the next task is to upload them to the cloud.</p><ol><li>Sign in to the <a href=https://console.developers.google.com/>Google Developers Console</a> and click Create Project.</li></ol><p><a href=http://varunpant.com/static/resources/image_10.png><img src=http://varunpant.com/static/resources/image_thumb_4.png alt=image title=image></a></p><p>2.Enable billing.</p><ol start=3><li>Create a Google Cloud storage bucket, choose the appropriate location and storage class.</li></ol><p><a href=http://varunpant.com/static/resources/image_12.png><img src=http://varunpant.com/static/resources/image_thumb_5.png alt=image title=image></a></p><p>And that's it you are all set. Finally click the bucket name and you will have the following options</p><p><a href=http://varunpant.com/static/resources/image_14.png><img src=http://varunpant.com/static/resources/image_thumb_6.png alt=image title=image></a></p><p>The easiest way to upload folders and tiles here is to click upload folder button and point to the folders on the disk. This is by far the easiest method, however in our case we have only generated tiles for first 8 zoom levels, so they are not much in number and using a web UI upload mechanism will work.</p><p>If we choose to generate large number of tiles and cover more than few countries we are possibly looking at millions to tiles specially around the street level (zoom 19 to 22), to cover such a scenario, I will recommend using another option in tilestache ,which directly allows saving the tiles in Google cloud storage. Tilestache, has a <a href=http://tilestache.org/doc/TileStache.Goodies.Caches.GoogleCloud.html>plugin</a> which can be used instead of a disk based cache. here is how to configure it</p><p>{ &ldquo;cache&rdquo;: { &ldquo;class&rdquo;: &ldquo;TileStache.Goodies.Caches.GoogleCloud:Cache&rdquo;, &ldquo;kwargs&rdquo;: { &ldquo;bucket&rdquo;: &ldquo;daa-transfers-static&rdquo;, &ldquo;access&rdquo;: &ldquo;accesstoken&rdquo;, &ldquo;secret&rdquo;: &ldquo;clientsecret&rdquo;&rdquo; } }, &ldquo;layers&rdquo;: { &ldquo;NE&rdquo;: { &ldquo;provider&rdquo;: {&ldquo;name&rdquo;: &ldquo;mapnik&rdquo;, &ldquo;mapfile&rdquo;: &ldquo;C:\Users\Varun Pant\Desktop\NE\NE.xml&rdquo;}, &ldquo;projection&rdquo;: &ldquo;spherical mercator&rdquo; } } } You will notice that to work with this plugin,one needs to have <strong>access token</strong> and** client secret**. This can be easily generated using the <a href=https://console.developers.google.com/>developer console</a>.</p><p>To setup, follow these steps</p><p>GS Security Credentials:</p><ol start=2><li>Select the project for Google cloud storage [Google APIs Console]</li><li>Select Google Cloud Storage</li><li>Select Make this my default project for interoperable storage access.</li><li>Select Interoperable Access.</li><li>You can find <strong>gs_access_key_id</strong> ,<strong>gs_secret_access_key</strong> for your project.
<a href=http://varunpant.com/static/resources/image_16.png><img src=http://varunpant.com/static/resources/image_thumb_7.png alt=image title=image></a></li></ol><p>Once configured run the tile seed command again and now, the tiles would be directly stored in the bucket, to access them use the following format <a href=http://storage.googleapis.com/>http://storage.googleapis.com/</a>&lt;bucket_name>//&lt;tile.png>.</p><p>In our case we can access the tiles like this.</p><p><a href=http://storage.googleapis.com/states-demo/NE/8/68/103.png title=http://storage.googleapis.com/states-demo/NE/8/68/103.png>http://storage.googleapis.com/states-demo/NE/8/68/103.png</a> , in the Html code given above, one can easily change the url from img.src = &ldquo;http://localhost:8080/NE/&rdquo; + zoom + &ldquo;/&rdquo; + coord.x + &ldquo;/&rdquo; + coord.y + &ldquo;.png&rdquo;; to img.src = "</p><p><a href=http://storage.googleapis.com/states-demo/NE/>http://storage.googleapis.com/states-demo</a>/NE/</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://varunpant.com/posts/read-gae-admin-backups-fromleveldb-format-and-export-gae-entities-using-bulkloader/><span class=button__icon>←</span>
<span class=button__text>Read GAE Admin Backups fromLevelDB format and export GAE Entities using bulkloader</span></a></span>
<span class="button next"><a href=https://varunpant.com/posts/install-all-go-project-dependencies-in-one-command/><span class=button__text>Install all Go project dependencies in one command</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Varun Pant</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2019 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://varunpant.com/assets/main.js></script><script src=https://varunpant.com/assets/prism.js></script></div></body></html>